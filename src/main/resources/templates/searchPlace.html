<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>조사지 검색</title>
</head>
<body>

<div class="search-place" th:fragment="search-Place-frag(treeList)">
    <div class="input-group mb-3">
        <input type="text" class="form-control" id="inputPlaceKeyword"
               placeholder="조사지를 입력하세요">
        <div class="input-group-append">
            <button class="btn btn-primary" type="button" id="search-place-btn">
                검색</button>
            <!--                alert(place); getResult(); return false;-->
        </div>
    </div>

    <div id="resultdiv">
        <div th:if="${searchList != null}">
            <h3 id="h3title"></h3>
            <script th:inline="javascript">
                /*<![CDATA[*/
                var rspPlace = /*[[${place}]]*/ 'default';
                var resultList = /*[[${searchList}]]*/ 'default';
                var treeList = /*[[${treeList}]]*/ 'default';
                var basalAreaList = /*[[${basalAreaList}]]*/ 'defalut';
                var adbh = /*[[${adbh}]]*/ 'defalut';
                var adbh_am = /*[[${adbh_am}]]*/ 'defalut';
                /*]]>*/

                console.log(basalAreaList)

                document.getElementById('h3title').innerHTML = " "+rspPlace + " 검색 결과 ";
                document.getElementById('h3title').innerHTML += resultList.length + " 건"
                        + " 검색되었습니다.";

            </script>
            <div th:if="${searchList != null}">
            <table class="table table-sm table-borderless table-hover">
                <tr>
                    <th scope="col">TID</th>
                    <th scope="col">표준지</th>
                    <th scope="col">흉고직경</th>
                    <th scope="col">흉고단면적</th>
                </tr>
                <tr th:each="streel : ${searchList}">
                    <td> <a th:href="@{'/webfist/map/'+${streel.tid}}" th:text="${streel.tid}"></a></td>
                    <td th:text="${streel.investigationPlace}"></td>
                    <td class="dbh" th:text="${streel.dbh}"></td>
                    <td th:id="${streel.tid}"></td>
                </tr>
            </table>
                <script>

                    for(key in basalAreaList){
                        let td = document.getElementById(key);
                        td.innerText = basalAreaList[key];
                    }
                </script>
            <table>
                <tr>
                    <td width="200px"><h4><b>평균 흉고단면적</b></h4></td> <td th:text="${aBA}"><h5></h5></td></tr><tr>
                </tr>
                <tr>
                    <td width="200px"><h4><b>1ha 당 흉고단면적</b></h4></td> <td th:text="${baPer1Ha}"><h5></h5></td>
                </tr>
                <tr>
                    <td  width="200px"><h4><b>평균 흉고직경<br>(흉고단면적법)</b></h4></td> <td th:text="${adbh}" ><h5></h5></td>
                    <td width="200px"><h4><b>평균 흉고직경<br>(산술평균법)</b></h4></td> <td th:text="${adbh_am}" ><h5></h5></td>
                </tr>
            </table>

            </div>


            <div id="map" style="width:800px;height:800px;"></div>
            <script>
                // 지도 관련 자바스크립트
                let container = document.getElementById('map'); //지도를 담을 영역의 DOM 레퍼런스

                let pos = new Array(resultList[resultList.length - 1].latitude, resultList[resultList.length - 1].longitude)
                let posLatLng = new kakao.maps.LatLng(pos[0],pos[1]);
                if(resultList[resultList.length-1].location!=null) {
                    pos = resultList[resultList.length - 1].location.split(",")
                }
                let options = { //지도를 생성할 때 필요한 기본 옵션
                    center: new kakao.maps.LatLng(pos[0], pos[1]), //지도의 중심좌표.
                    level: 3 //지도의 레벨(확대, 축소 정도)
                };
                let map = new kakao.maps.Map(container, options); //지도 생성 및 객체 리턴

                // 마커를 생성합니다
                var imageSrc = "/icon/treeicon.png";


                let maxdist=0
                var pos2=null;
                for (var i = 0; i < treeList.length; i ++) {
                    // 마커 이미지의 이미지 크기 입니다

                    var imageSize = new kakao.maps.Size(24, 35);
                    // 마커 이미지를 생성합니다
                    var markerImage = new kakao.maps.MarkerImage("/icon/treeicon.png", imageSize);

                    for(var j=0; j<resultList.length;j++){
                        if(treeList[i].tid == resultList[j].tid) {
                            if(Math.round(resultList[j].dbh) == Math.round(adbh) ||Math.round(resultList[j].dbh) == Math.round(adbh_am))
                                markerImage = new kakao.maps.MarkerImage("/icon/treeiconred.png", imageSize);
                            else
                                markerImage = new kakao.maps.MarkerImage("/icon/treeiconblue.png", imageSize);

                            l1 = new kakao.maps.LatLng(pos[0], pos[1])
                            pos2 = new Array(resultList[j].latitude, resultList[j].longitude);
                            l2 = new kakao.maps.LatLng(pos2[0], pos2[1])


                            line =  new kakao.maps.Polyline({
                                map: map,
                                path:[l1,l2]
                            })

                            var distance = Math.round(line.getLength());
                            if (line) {
                                line.setMap(null);
                                line = null;
                            }
                            if(distance>maxdist)
                            {
                                maxdist=distance;
                            }
                        }
                    }


                    // 마커를 생성합니다
                    var marker = new kakao.maps.Marker({
                        map: map, // 마커를 표시할 지도
                        position: new kakao.maps.LatLng(treeList[i].latitude, treeList[i].longitude), // 마커를 표시할 위치
                        title : treeList[i].tid, // 마커의 타이틀, 마커에 마우스를 올리면 타이틀이 표시됩니다
                        image : markerImage // 마커 이미지
                    });
                    //console.log(marker.getPosition())
                }

                console.log(maxdist)
                var circle = new kakao.maps.Circle({
                    center : new kakao.maps.LatLng(pos[0], pos[1]),  // 원의 중심좌표 입니다
                    radius: maxdist, // 미터 단위의 원의 반지름입니다
                    strokeWeight: 5, // 선의 두께입니다
                    strokeColor: '#75B8FA', // 선의 색깔입니다
                    strokeOpacity: 1, // 선의 불투명도 입니다 1에서 0 사이의 값이며 0에 가까울수록 투명합니다
                    strokeStyle: 'dashed', // 선의 스타일 입니다
                    fillColor: '#CFE7FF', // 채우기 색깔입니다
                    fillOpacity: 0.5  // 채우기 불투명도 입니다
                });
                circle.setMap(map);
            </script>
        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript">

        var investplace ;

        $(document).ready(function () {
                $('#search-place-btn').click(function (){
                    investplace = document.getElementById('inputPlaceKeyword');
                    var place = investplace.value;
                    console.log('검색 버튼 클릭');
                    console.log(place);
                    location.href = "/webfist/map/other/1/" + place.toString();
                });
            }
        );


    </script>


</div>
</body>

</html>